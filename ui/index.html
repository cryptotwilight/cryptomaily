<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Crypto Maily</title>
    <!-- base:css -->
    <link rel="stylesheet" href="vendors/mdi/css/materialdesignicons.min.css">
    <link rel="stylesheet" href="vendors/css/vendor.bundle.base.css">

    <link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css" integrity="sha384-AYmEC3Yw5cVb3ZcuHtOA93w35dYTsvhLPVnYs9eStHfGJvOvKxVfELGroGkvsg+p" crossorigin="anonymous" />

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <!-- endinject -->
    <!-- plugin css for this page -->
    <!-- End plugin css for this page -->
    <!-- inject:css -->
    <link rel="stylesheet" href="css/style.css">
    <!-- endinject -->
    <link rel="shortcut icon" href="images/favicon.png" />
    <script src="https://unpkg.com/ipfs-http-client-lite/dist/index.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <script src="https://cdn.ethers.io/lib/ethers-5.0.umd.min.js" type="text/javascript">
    </script>
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>

    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/ethjs@0.3.4/dist/ethjs.min.js"></script>

    <script type="text/javascript" src="abi/ICryptoMaily.js"></script>
    <script type="text/javascript" src="abi/IcmPouch.js"></script>
    <script type="text/javascript" src="abi/IcmReadMessage.js"></script>
    <script type="text/javascript" src="abi/IERC20.js"></script>

</head>

<body>
    <div class="container-scroller d-flex">
        <!-- partial:./partials/_sidebar.html -->
        <nav class="sidebar sidebar-offcanvas" id="sidebar">
            <ul class="nav">
                <li class="nav-item sidebar-category">
                    <p>Navigation</p>
                    <span></span>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="index.html">
                        <i class="mdi mdi-view-quilt menu-icon"></i>
                        <span class="menu-title">Inbox</span>
                        <div class="badge badge-info badge-pill">2</div>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="01_compose.html">
                        <i class="fa fa-pen-alt menu-icon"></i>
                        <span class="menu-title">Compose</span>
                    </a>
                </li>

            </ul>
        </nav>
        <!-- partial -->
        <div class="container-fluid page-body-wrapper">
            <!-- partial:./partials/_navbar.html -->
            <nav class="navbar col-lg-12 col-12 px-0 py-0 py-lg-4 d-flex flex-row">
                <div class="navbar-menu-wrapper d-flex align-items-center justify-content-end">
                    <button class="navbar-toggler navbar-toggler align-self-center" type="button" data-toggle="minimize">
                         <span class="mdi mdi-menu"></span>
                     </button>
                    <div class="navbar-brand-wrapper">
                        <a class="navbar-brand brand-logo" href="index.html"><img src="images/logo.svg" alt="logo" /></a>
                        <a class="navbar-brand brand-logo-mini" href="index.html"><img src="images/logo-mini.svg" alt="logo" /></a>
                    </div>
                    <h4 class="font-weight-bold mb-0 d-none d-md-block mt-1" style="color: black;">Crypto Maily</h4>
                    <ul class=" navbar-nav navbar-nav-right ">
                        <li>
                            <span id="show_wallet"></span>
                        </li>
                        <li class="nav-item ">
                            <button type="button " class="btn btn-primary btn-rounded btn-fw " id="connect_web_3">Connect Web 3</button>
                        </li>

                    </ul>
                    <button class="navbar-toggler navbar-toggler-right d-lg-none align-self-center " type="button " data-toggle="offcanvas ">
                        <span class="mdi mdi-menu "></span>
                    </button>
                </div>

            </nav>
            <!-- partial -->
            <div class="main-panel ">
                <div class="content-wrapper ">

                    <div class="row ">
                        <div class="col-lg-12 grid-margin stretch-card ">
                            <div class="card ">
                                <div class="card-body ">
                                    <h4 class="card-title ">Latest Messages</h4>
                                    <div class="table-responsive ">
                                        <span id="cm_inbox"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- row end -->
                </div>
                <!-- content-wrapper ends -->

                <!-- partial:./partials/_footer.html -->
                <footer class=" footer ">
                    <div class="card ">
                        <div class="card-body ">
                            <div class="d-sm-flex justify-content-center justify-content-sm-between ">
                                <span class="text-muted d-block text-center text-sm-left d-sm-inline-block ">Copyright Â© Crypto Maily 2021</span>
                            </div>
                        </div>
                    </div>
                </footer>
                <!-- partial -->
            </div>
            < <!-- main-panel ends -->
        </div>
        <!-- page-body-wrapper ends -->
    </div>
    <!-- container-scroller -->


    <script src="js/bootstrap.bundle.min.js "></script>
    <!-- base:js -->

    <script src="vendors/js/vendor.bundle.base.js ">
    </script>
    <!-- endinject -->
    <!-- Plugin js for this page-->
    <script src="vendors/chart.js/Chart.min.js "></script>
    <!-- End plugin js for this page-->
    <!-- inject:js -->
    <script src="js/off-canvas.js "></script>
    <script src="js/hoverable-collapse.js "></script>
    <script src="js/template.js "></script>
    <!-- endinject -->
    <!-- plugin js for this page -->
    <!-- End plugin js for this page -->
    <!-- Custom js for this page-->
    <script src="js/dashboard.js "></script>
    <!-- End custom js for this page-->
    <script>
        const onboardButton = document.getElementById("connect_web_3");
        const showWallet = document.getElementById("show_wallet");

        const ipfs = window.IpfsHttpClientLite('http://localhost:5001')
        const Buffer = window.IpfsHttpClientLite.Buffer;

        console.log("got ipfs: " + ipfs);

        const web3 = new Web3(ethereum);
        console.log("web3 : " + web3);

        var account;

        //Created check function to see if the MetaMask extension is installed
        const isMetaMaskInstalled = () => {

            const {
                ethereum
            } = window;
            return Boolean(ethereum && ethereum.isMetaMask);
        };

        const MetaMaskClientCheck = () => {
            //Now we check to see if Metmask is installed
            if (!isMetaMaskInstalled()) {
                console.log("metamask not installed");
                //If it isn't installed we ask the user to click to install it
                onboardButton.innerText = 'Click here to install MetaMask!';
                //When the button is clicked we call this function
                onboardButton.onclick = onClickInstall;
                //The button is now disabled
                onboardButton.disabled = false;
            } else {
                //If it is installed we change our button text
                onboardButton.innerText = 'Click to Connect Metamask';
                console.log("metamask installed");
                onboardButton.addEventListener('click', () => {
                    getAccount();
                    onboardButton.innerText = "Web 3 Connected";
                    console.log(" loading getting inbox ");
                    getInbox();
                });
            }
        };
        const initialize = () => {
            MetaMaskClientCheck();

        };

        window.addEventListener('DOMContentLoaded', initialize);

        async function getAccount() {
            const accounts = await ethereum.request({
                method: 'eth_requestAccounts'
            });
            account = accounts[0];
            showWallet.innerHTML = "<b>Connected Wallet :: " + account + "</b>";
        }

        //We create a new MetaMask onboarding object to use in our app
        //const onboarding = new MetaMaskOnboarding({ forwarderOrigin });

        //This will start the onboarding proccess
        const onClickInstall = () => {
            onboardButton.innerText = 'Onboarding in progress';
            onboardButton.disabled = true;
            //On this object we have startOnboarding which will start the onboarding process for our end user
            onboarding.startOnboarding();
        };

        const onClickConnect = async() => {
            try {
                // Will open the MetaMask UI
                // You should disable this button while the request is pending!
                await ethereum.request({
                    method: 'eth_requestAccounts'
                });
            } catch (error) {
                console.error(error);
            }
        };

        console.log("got abi : " + icryptoMailyAbi);

        const icryptoMailyAddress = "0x5D385910EF284C445cFe60F922CC70C67596Dd00";// local
        //const icryptoMailyAddress = "0xE078D1805884f0c2f83C833c38DD1837cb248c7F"; //Avalanche FuJI
        //const icryptoMailyAddress = ""; // BSC
        //const icryptoMailyAddress = "0xE078D1805884f0c2f83C833c38DD1837cb248c7F"; // HECO

        const iCryptoMailyContract = new web3.eth.Contract(icryptoMailyAbi, icryptoMailyAddress);

        const INBOX_HEADERS = ["From", "Sender Address", "Subject", "Pouch", "Attachments", "", ""];

        const INBOX_ICONS = ["fa fa-laptop", "fa fa-location-arrow", "fa fa-scroll-old", "fa fa-sack-dollar", "fa fa-paperclip", "", ""];


        const inboxMesageContracts = new Map();

        const inboxSpace = document.getElementById("cm_inbox");

        async function getInbox() {




            console.log(" calling blockchain ");

            await iCryptoMailyContract.methods.getAllInboxMail().call({
                    from: account
                })
                .then(function(result) {

                    inboxSpace.innerHTML = "";
                    console.log(" getting inbox ");

                    var table = document.createElement("table");
                    table.setAttribute("class", "table table-striped");

                    var header = table.insertRow();

                    for (var x = 0; x < INBOX_HEADERS.length; x++) {
                        var th = document.createElement("th");
                        var txt = document.createTextNode(INBOX_HEADERS[x]);
                        th.appendChild(txt);
                        var i = document.createElement("i");
                        i.setAttribute("class", INBOX_ICONS[x]);
                        th.append(i);
                        header.appendChild(th);
                    }
                    var thb = document.createElement("th");
                    header.appendChild(thb);

                    console.log((" got it " + result));
                    console.log((" got it " + result.length));
                    var y = 0;
                    while (y < result.length) {
                        console.log("building rows");
                        var row = table.insertRow();
                        var messageAddress = result[y];
                        const messageContract = new web3.eth.Contract(icmReadMessageAbi, messageAddress);
                        inboxMesageContracts.set(messageAddress, messageContract);
                        var td = row.insertCell();
                        var img = document.createElement("img");
                        img.setAttribute("src", "images/faces/starman.png");
                        td.appendChild(img);
                        var ad = row.insertCell();
                        var sub = row.insertCell();
                        var pou = row.insertCell();
                        var att = row.insertCell();

                        messageContract.methods.getSender().call({
                                from: account
                            })
                            .then(function(result) {
                                console.log(result);
                                var addressText = document.createTextNode(result);

                                console.log(addressText);
                                ad.appendChild(addressText);
                            });

                        messageContract.methods.getSubject().call({
                                from: account
                            })
                            .then(function(result) {
                                var subjectText = document.createTextNode(result);
                                messageContract.methods.getMessage().call({
                                    from: account
                                })
                                .then(function(result){
                                    console.log(result);
                                    var a = document.createElement("a");
                                    a.setAttribute("href", "ipfs://"+result);
                                    a.setAttribute("target", "_blank");
                                    a.appendChild(subjectText);
                                    sub.appendChild(a);
                                });
                            });


                        messageContract.methods.getAttachments().call({
                                from: account
                            })
                            .then(function(result) {
                                console.log("attachments : " + result);
                                var attachmentCountText = document.createTextNode(result.attachmentTitle.length);
                                att.appendChild(attachmentCountText);
                            });

                        messageContract.methods.getPouches().call({
                                from: account
                            })
                            .then(function(result) {
                                console.log("pouches : " + result);
                                var pouchCountText = document.createTextNode(result._pouchList.length);
                                pou.appendChild(pouchCountText);
                            });


                        var read = row.insertCell();
                        var readIcon = document.createElement("i");
                        readIcon.setAttribute("class", "mdi mdi-email-open");
                        read.appendChild(readIcon);

                        var delete_ = row.insertCell();
                        var trashIcon = document.createElement("i");
                        trashIcon.setAttribute("class", "mdi mdi-trash-can");
                        delete_.appendChild(trashIcon);



                        y++;
                    }

                    console.log(table);
                    console.log("table : " + table);
                    inboxSpace.appendChild(table);
                });
        }



        function readMessage() {

        }

        function deleteMessage() {

        }

        function viewPouch() {

        }
    </script>
</body>

</html>